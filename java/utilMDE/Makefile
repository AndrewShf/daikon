### User customizations

# Put user-specific changes in your own Makefile.user
#  (such as changes to UTILMDE_DIR or JAVAC).
# Make will silently continue if file does not exist.
-include Makefile.user

JAVA ?= java
JAVAC ?= javac -g
# JAVAC ?= jikes -g +E +F


JAVA_FILES := $(shell find . \( -name CVS \) -prune -o -name '*.java' -print)
JAVA_CPP_FILES := $(shell find . \( -name CVS \) -prune -o -name '*.java.jpp' -print)
ALL_JAVA_FILES := ${JAVA_FILES} ${JAVA_CPP_FILES}
AUTO_GENERATED_FILES = \
	MathMDE.java \
	LimitedSizeIntSet.java

default: all

all: all_notest test

all_javac: all_javac_notest test

all_javac_notest:  ${AUTO_GENERATED_FILES}
	javac -g ${JAVAC_EXTRA_ARGS} ${JAVA_FILES}

all_notest: ${AUTO_GENERATED_FILES}
	${JAVAC} ${JAVA_FILES}

clean:
	rm -f *.class

very_clean: clean
	rm -f ${AUTO_GENERATED_FILES}

tags:
	etags ${ALL_JAVA_FILES}

# Run Jikes unconditionally.
# This "set" form doesn't seem to work for me (maybe needs to be export?).
# Used to depend on targets "clean all", but I want to run this in "all".
test:
	set JAVA_COMPILER=NONE; ${JAVA} utilMDE.TestUtilMDE

doc: javadoc

javadoc: $(JAVA_FILES)
	mkdir -p doc
	# javadoc 1.4 doesn't like being given package names; give all *.java files instead
	javadoc -d doc utilMDE
	# makes "doc" (the target of this rule) look up to date
	touch doc
	jdk-add-munged-anchor-names-no-bak doc/utilMDE/*.html
	@echo "Run jdk-index-to-alist (see ~/bin/share/jdk-index-to-alist)"

audit:
	(cd ..; maudit utilMDE)

# No need to do "make doc" or "make all" before running this.
# (This includes .class files, so users don't need to recompile.)
utilMDE.tar.gz: $(ALL_JAVA_FILES) Makefile README
	rm -rf /tmp/utilMDE
	mkdir /tmp/utilMDE
	cp -p $(ALL_JAVA_FILES) /tmp/utilMDE
	cp -p Makefile README /tmp/utilMDE
	(cd /tmp/utilMDE; make JAVAC_EXTRA_ARGS='-classpath .:${DAIKONDIR}/java/lib/junit.jar' all_javac_notest doc)
	(cd /tmp; tar zcf utilMDE.tar.gz utilMDE)
	rm -f utilMDE.tar.gz
	mv /tmp/utilMDE.tar.gz .
	rm -rf /tmp/utilMDE

showvars:
	@echo ALL_JAVA_FILES = $(ALL_JAVA_FILES)
	@echo JAVA_FILES = $(JAVA_FILES)
	@echo JAVA_CPP_FILES = $(JAVA_CPP_FILES)


###########################################################################
### Automatically generated files
###

# JAVA_CPP = java-cpp.pl $< -DDEFINEDVAR > $@
# This rule does not work with make 3.77, but does work with make 3.78.
JAVA_CPP ?= (rm -f $@; java-cpp.pl -DDEFINEDVAR $< 2>&1 > $@ && chmod -w $@)

MathMDE.java: MathMDE.java.jpp MathMDE-gcd.java.jpp MathMDE-modulus.java.jpp MathMDE-nonmodulus.java.jpp MathMDE-help.java.jpp MathMDE-helpend.java.jpp
	$(JAVA_CPP)

LimitedSizeIntSet.java: LimitedSizeSet.java.jpp
	$(JAVA_CPP:DEFINEDVAR=TYPEINT)


###########################################################################
###
###

# Existence of this rule means that a target is deleted if has just changed
# and its rule commands exit with nonzero status.  It's needed for the
# java-cpp rules above.
# (Actually, it isn't anymore, for I arrange not to overwrite the file
# unless success.  But leave it in for now anyway.)

.DELETE_ON_ERROR:

# end
